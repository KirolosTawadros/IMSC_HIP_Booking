# ميزة إلغاء الحجز - Cancel Booking Feature

## نظرة عامة
تم إضافة ميزة إلغاء الحجز للتطبيق، مما يسمح للأطباء بإلغاء حجوزاتهم القادمة. **الحجوزات الملغية تبقى مرئية** في قائمة الحجوزات مع حالة "ملغي".

## الميزات المضافة

### 1. Backend API
- **Endpoint:** `DELETE /api/bookings/:bookingId`
- **الوظيفة:** تغيير حالة الحجز إلى "ملغي" بدلاً من الحذف
- **التحققات:**
  - التأكد من وجود الحجز
  - التأكد من أن الحجز في المستقبل
  - التأكد من أن الميعاد لم يبدأ بعد (للحجوزات في نفس اليوم)
  - التأكد من أن الحجز لم يلغ من قبل
- **الاستجابة:** رسالة نجاح + إشعار للمستخدم

### 2. Frontend (Mobile App)
- **شاشة حجوزاتي:** إضافة زر "إلغاء الحجز" للحجوزات القابلة للإلغاء
- **عرض الحجوزات الملغية:** الحجوزات الملغية تظهر في القائمة بحالة "ملغي"
- **التحققات:** عرض زر الإلغاء فقط للحجوزات المستقبلية (pending/approved)
- **تأكيد الإلغاء:** نافذة تأكيد قبل الإلغاء
- **معالجة الأخطاء:** رسائل خطأ واضحة للمستخدم

### 3. Admin Panel
- **عرض الحجوزات الملغية:** إضافة حالة "ملغي" في admin panel
- **إحصائيات:** إضافة عداد للحجوزات الملغية
- **فلترة:** إمكانية فلترة الحجوزات حسب حالة "ملغي"
- **حماية:** لا يمكن تغيير حالة الحجوزات الملغية

### 4. الترجمات
تم إضافة الترجمات التالية:
- `cancel_booking`: "إلغاء الحجز"
- `cancel_booking_confirm`: "هل أنت متأكد من إلغاء هذا الحجز؟"
- `cancel_booking_success`: "تم إلغاء الحجز بنجاح"
- `cancel_booking_error`: "فشل في إلغاء الحجز"
- `cannot_cancel_past`: "لا يمكن إلغاء الحجوزات السابقة"
- `cannot_cancel_started`: "لا يمكن إلغاء الحجوزات التي بدأت بالفعل"
- `cancelled`: "ملغي"
- `already_cancelled`: "الحجز ملغي بالفعل"

## كيفية العمل

### شروط إلغاء الحجز:
1. **الحجز في المستقبل:** لا يمكن إلغاء الحجوزات السابقة
2. **الميعاد لم يبدأ:** لا يمكن إلغاء الحجوزات التي بدأت بالفعل في نفس اليوم
3. **الحجز موجود:** يجب أن يكون الحجز موجود في قاعدة البيانات
4. **الحجز قابل للإلغاء:** فقط الحجوزات بحالة "pending" أو "approved"
5. **لم يلغ من قبل:** لا يمكن إلغاء حجز ملغي بالفعل

### عملية الإلغاء:
1. المستخدم يضغط على زر "إلغاء الحجز"
2. يظهر تأكيد الإلغاء
3. عند التأكيد، يتم إرسال طلب DELETE للـ API
4. يتم تغيير حالة الحجز إلى "cancelled" في قاعدة البيانات
5. يتم إضافة ملاحظة "[ملغي بواسطة الطبيب]" للحجز
6. يتم إنشاء إشعار للمستخدم
7. يتم تحديث قائمة الحجوزات

### عرض الحجوزات الملغية:
- **Mobile App:** تظهر الحجوزات الملغية في شاشة "حجوزاتي" بحالة "ملغي"
- **Admin Panel:** تظهر الحجوزات الملغية في جدول الحجوزات مع إحصائيات منفصلة

## الملفات المعدلة

### Backend:
- `backend/models/Booking.js` - إضافة حالة "cancelled" إلى enum
- `backend/models/Notification.js` - إضافة نوع "booking_cancelled" وإزالة إلزامية booking_id
- `backend/routes/bookings.js` - تحديث endpoint إلغاء الحجز لتغيير الحالة بدلاً من الحذف

### Frontend:
- `mobile/services/api.js` - إضافة API function
- `mobile/app/screens/MyBookingsScreen.tsx` - إضافة واجهة الإلغاء وعرض الحجوزات الملغية
- `mobile/app/screens/HomeScreen.tsx` - تحديث الترجمات
- `mobile/assets/locales/ar.json` - إضافة الترجمات العربية
- `mobile/assets/locales/en.json` - إضافة الترجمات الإنجليزية
- `admin/src/components/ModernBookingManagement.js` - إضافة حالة "ملغي" في admin panel

## اختبار الميزة

### اختبار إلغاء حجز مستقبلي:
1. إنشاء حجز لموعد في المستقبل
2. الذهاب لشاشة "حجوزاتي"
3. الضغط على زر "إلغاء الحجز"
4. تأكيد الإلغاء
5. التحقق من تغيير حالة الحجز إلى "ملغي"
6. التحقق من بقاء الحجز في القائمة

### اختبار إلغاء حجز سابق (يجب أن يفشل):
1. محاولة إلغاء حجز لموعد سابق
2. يجب أن تظهر رسالة خطأ "لا يمكن إلغاء الحجوزات السابقة"

### اختبار إلغاء حجز ملغي (يجب أن يفشل):
1. محاولة إلغاء حجز ملغي بالفعل
2. يجب أن تظهر رسالة خطأ "الحجز ملغي بالفعل"

### اختبار Admin Panel:
1. فتح admin panel
2. التحقق من ظهور إحصائيات الحجوزات الملغية
3. التحقق من إمكانية فلترة الحجوزات حسب حالة "ملغي"
4. التحقق من عدم إمكانية تغيير حالة الحجوزات الملغية

## ملاحظات تقنية

### الأمان:
- التحقق من صحة البيانات قبل الإلغاء
- معالجة الأخطاء بشكل مناسب
- إنشاء إشعارات للمستخدم
- حماية من الإلغاء المتكرر

### الأداء:
- تحديث فوري لقائمة الحجوزات
- معالجة حالة التحميل أثناء الإلغاء
- عدم إعادة تحميل البيانات غير الضرورية

### تجربة المستخدم:
- رسائل واضحة ومفهومة
- تأكيد الإلغاء لتجنب الأخطاء
- تغذية راجعة فورية للمستخدم
- عرض الحجوزات الملغية للشفافية

### قاعدة البيانات:
- الحجوزات الملغية تبقى في قاعدة البيانات
- إضافة ملاحظة توضح سبب الإلغاء
- تتبع تاريخ الإلغاء عبر timestamps 